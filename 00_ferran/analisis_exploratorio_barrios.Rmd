---
title: "Análisis Exploratorio de los barrios" 
author: "Ferran Aragó"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, warning=FALSE, message=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(sf)
library(arrow)
library(geojsonsf)
library(gridExtra)
```

# Exploración de las estructuras de datos

Los datos de los que se compone nuestro dataset son los siguientes:

- `barrio`: Nombre del barrio. Será una variable de tipo carácter.

- `estaciones_valenbisi`: Número de estaciones de Valenbisi en el barrio. Será una variable de tipo numérica discreta.

- `geo_shape`: Forma geográfica del barrio. Será una variable de tipo geoJson, que se puede transformar a un objeto de tipo POLYGON del paquete sf.

- `Total_población`: Número total de habitantes en el barrio. Será una variable de tipo numérica discreta. También se incluye la población total separada por rangos de edad.

- `superficie_barrio`: Superficie del barrio en $m^2$. Será una variable de tipo numérica continua.

- `paradas_emt`: Número de paradas de la EMT en el barrio. Será una variable de tipo numérica discreta.

- `paradas_metro`: Número de paradas de metro en el barrio. Será una variable de tipo numérica discreta.

- `plazas_mob`: Número de plazas de aparcamiento destinadas a gente con movilidad reducida. Será una variable de tipo numérica discreta.

- `paradas_taxis`: Número de paradas de taxis en el barrio. Será una variable de tipo numérica discreta.

- `plazas_parkings`: Número de plazas de aparcamiento en el barrio. Será una variable de tipo numérica discreta.

- `superficie_zonas_verdes`_ Superficie de zonas verdes en el barrio en m^2. Será una variable de tipo numérica continua.

- `precio_alquiler`: Precio medio del alquiler por metro cuadrado en el barrio. Será una variable de tipo numérica continua.

- `distrito`: Nombre del distrito al que pertenece el barrio. Será una variable de tipo categórica, ya que hay 19 distritos en total.

- `amenity`: Número de servicios de comida que hay en el barrio. Será una variable de tipo numérica discreta.

- `monuments`: Número de puntos históricos que hay en el barrio como pueden ser iglesias, estatuas, etc. Será una variable de tipo numérica discreta.

- `shop`: Número de tiendas de productos básicos, por ejemplo supermercados, fruterías, farmacias, etc. Será una variable de tipo numérica discreta.

- `sport`: Número de instalaciones deportivas que hay en el barrio. Será una variable de tipo numérica discreta.


# Estadísticas descriptivas

```{r estadisticas_descriptivas}
df <- read_parquet("../data/info_general_barrio.parquet")

summary(df)
```

Del resumen estadístico extraído, podemos observar la existencia de dos variables que tienen una gran cantidad de valores faltantes, `paradas_metro` y `plazas_parkings`. Esto se debe a que ambas están situadas de forma que se distribuyan por toda la ciudad sin haber una gran densidad de ambas, por ello, se tiene que muchos barrios no tengan ninguna de las dos.

Es posible que se desee no contar con ninguna de las dos variables, ya que, al tener un gran número de valores faltantes, puede afectar al análisis. No obstante, estos valores faltantes no son un error ni dejan de ser significativos, ya que ambos, tanto las paradas de metro como las plazas de parkings, están situados de forma estratégica ocupando los lugares en los que vayan a tener más afluencia de gente.




# Análisis de valores faltantes

Puesto que el dataset con el que vamos a trabajar se ha obtenido mediante la comprobación geográfica de la localización de los distintos elementos a analizar y estableciendo así el número de elementos que tiene cada barrio y que los archivos consultados para ello son extraídos de fuentes oficiales, no se esperan valores atípicos que impliquen la necesidad de no tenerlos en cuenta.

Por ello, vamos a centrar nuestro esfuerzo en la búsqueda de valores faltantes, ya que es posible que hayan variables que se vean reducidas a muy pocos barrios o barrios que no tengan información de gran cantidad de las variables incluidas y pueden afectar a los posteriores análisis. Estos valores nulos serán convertidos en 0, ya que indican la no existencia de dicho elemento en el barrio, pero se mantienen como nulos para poder trabajar más fácilmente con ellos.


## Tratamiento de las variables

Como se ha dicho en el resumen estadístico anterior, las variables `paradas_metro` y `plazas_parkings` son las que tienen un mayor número de valores faltantes. De forma que serán el principal objetivo de este apartado.

La forma de la que se maximiza la cantidad de barrios sin valores faltantes es eliminando la variable `plazas_parkings` y, para no perder la información de las paradas de metro, ya que es una de nuestras bases del análisis, vamos a juntar las variables `paradas_emt` y `paradas_metro` en una sola variable llamada `trans_publico`, que será la suma de ambas.


```{r proporción_faltantes}
'
df2 <- df
df2$paradas_emt[is.na(df2$paradas_emt)] <- 0
df2$paradas_metro[is.na(df2$paradas_metro)] <- 0

df2$trans_publico <- df2$paradas_emt + df2$paradas_metro

df2$trans_publico[which(df2$trans_publico == 0)] <- NA

df2 <- df2 %>% select(-c("paradas_emt", "plazas_parkings", "paradas_metro"))

num_faltantes <- cbind(df2[,1], n_faltantes = df2 %>% 
                         apply(1, function(x) sum(is.na(x))))
'
```

De esta forma es como más se consigue un mayor número de barrios con ninguna variable con valores faltantes, con una total de `r nrow(num_faltantes[which(num_faltantes$n_faltantes == 0),])`.

## Número de barrios con valores faltantes por distrito

Tras realizar un primer vistazo al dataset que habíamos obtenido, quisimos comprobar si los valores faltantes se concentraban en gran parte en barrios que tuviesen una característica en común, como por ejemplo, pertenecer a un mismo distrito. Para ello, vamos a comprobar cuántos barrios de cada distrito tienen valores faltantes en alguna de las variables.

```{r max_faltantes}
# Vamos a comprobar si hay valores faltantes en el dataset

faltantes <- df2 %>% group_by(distrito) %>% summarise_all(~sum(is.na(.)))
# Quitamos la población por rangos de edad, ya que son variables prescindibles
faltantes <- faltantes %>% select(-c("X0_15_años", "X16_64_años", "X65_o_más"))

max_faltantes <- cbind(faltantes %>% select(distrito), n_faltantes = faltantes %>% 
                         select(-distrito) %>% apply(1, max))
max_faltantes <- max_faltantes %>% arrange(distrito) # Para ordenarlo por distrito

ggplot(max_faltantes, aes(x = distrito, y = n_faltantes)) +
  geom_bar(stat = "identity", fill = "mediumaquamarine") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Número de barrios con valores faltantes por distrito",
       x = "Distrito",
       y = "Número de barrios")
```

En este gráfico se recoge el número máximo de barrios con valores faltantes para una misma variable por distrito, es decir, para cada distrito, la variable con mayor número de barrios de dicho distrito con valores faltantes.

Visualizando este primer gráfico, hay dos distritos que parecen tener un mayor número de barrios con valores faltantes en una variable a comparación del resto. Estos distritos son `Poblats de nord` y `Poblats del sud`. Tal vez sea porque, al situarse en los exteriores de la ciudad, no tiene tantos servicios como el resto de distritos. Pero antes de establecer que estos dos distritos son los que más barrios tienen con valores faltantes, vamos a comparar los valores extraídos con el total de barrios del distrito y así comprobar si realmente es un valor significativo, ya que podrían ser distritos con un número muy elevado de barrios y por eso tener mayor número de barrios con faltantes.

```{r porcentaje_faltantes}
num_barrios <- df %>% group_by(distrito) %>% summarise(n = n())
num_barrios <- num_barrios %>% arrange(distrito)

max_faltantes <- cbind(max_faltantes, porcentaje_barrios =
                         max_faltantes$n_faltantes / num_barrios$n * 100)

ggplot(max_faltantes, aes(x = distrito, y = porcentaje_barrios)) +
  geom_bar(stat = "identity", fill = "mediumaquamarine") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Porcentaje de barrios con valores faltantes por distrito",
       x = "Distrito",
       y = "Número de valores faltantes")
```

Tras realizar este segundo gráfico, el cual nos muestra que porcentaje de barrios de cada distrito tienen valores faltantes, confirmamos que los distritos `Poblats de nord` y `Poblats del sud` son los que tienen un mayor número de barrios con valores faltantes para una variable concreta, pero, a pesar de no resultar significativo en el anterior gráfico, el distrito `Poblats de l'oest` también tiene valores faltantes en todos sus barrios. 




## Número de variables con valores faltantes por distrito

Por ello, es posible que se quieran eliminar estos barrios de nuestro dataset, ya que al no tener información de gran parte de las variables, no aportarán información relevante. Comprobamos la información por distritos porque si se quiere eliminar algún barrio sería conveniente eliminar el distrito completo, ya que sino podría afectar al posterior análisis de clustering.



```{r n_var_faltantes}
n_var_faltantes <- faltantes %>% summarise(n = apply(faltantes, 1, 
  function(x) sum(x > 0)-1)) %>% cbind(distrito = faltantes$distrito, var_with_null = .)

ggplot(n_var_faltantes, aes(x = distrito, y = n)) +
  geom_bar(stat = "identity", fill = "mediumaquamarine") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Número de variables con valores faltantes por distrito",
       x = "Distrito",
       y = "Número de variables con valores faltantes")
```

Se puede ver que los distritos de `Poblats del Nord` y `Poblats del Sud` son los que tienen un mayor número de variables con valores faltantes, por lo que, serán candidatos a ser eliminados del dataset.

Previo a eliminarlos, vamos a analizar si son tan solo unos pocos barrios de estos distritos los que tienen muchas variables con valores faltantes o si es un problema que se extiende a todos los barrios de ambos distritos.


```{r faltantes_barrio, fig.width=10, fig.height=8}
poblats_nord <- df2[which(df2$distrito == "POBLATS DEL NORD"),]
faltantes_barrio_nord <- poblats_nord %>% group_by(barrio) %>% summarise_all(~sum(is.na(.)))
faltantes_barrio_nord <- data.frame(barrio = poblats_nord$barrio, 
                          n_faltantes = faltantes_barrio_nord %>% select(-barrio) %>% apply(1, sum))

poblats_sud <- df2[which(df2$distrito == "POBLATS DEL SUD"),]
faltantes_barrio_sud <- poblats_sud %>% group_by(barrio) %>% summarise_all(~sum(is.na(.)))
faltantes_barrio_sud <- data.frame(barrio = poblats_sud$barrio, 
                          n_faltantes = faltantes_barrio_sud %>% select(-barrio) %>% apply(1, sum))

ggplot(faltantes_barrio_nord, aes(x = barrio, y = n_faltantes)) +
  geom_bar(stat = "identity", fill = "mediumaquamarine") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Número de variables con valores faltantes por barrios de Poblats del Nord",
       x = "Barrio",
       y = "Número de variables con valores faltantes")


ggplot(faltantes_barrio_sud, aes(x = barrio, y = n_faltantes)) +
  geom_bar(stat = "identity", fill = "mediumaquamarine") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(title = "Número de variables con valores faltantes por barrios de Poblats del Sud",
       x = "Barrio",
       y = "Número de variables con valores faltantes")
```

Con ambos gráficos comprobamos que es un problema general de los distritos. Sobre todo en el distrito de `Poblats del Nord`, podemos ver que el barrio que menor número de variables con valores faltantes es Poble nou y tiene 5 variables, que supone un 26% del total de nuestras variables. Por otro lado, en el distrito de `Poblats del Sud`, hay algunos barrios con pocas variables con valores faltantes, pero estos suponen una mínima parte de este distrito.

Teniendo esto en cuenta, decidimos eliminar ambos distritos de nuestra base de datos.

```{r base_final}
df_final <- df2[which(df2$distrito != "POBLATS DEL NORD" & df2$distrito != "POBLATS DEL SUD"),]

write_parquet(df_final, "../data/info_general_barrio_final.parquet")
write.csv(df_final, "../data/info_general_barrio_final.csv")

summary(df_final)
```

Decidimos conservar la variable `monuments` ya que resulta lógico que no hayan muchos barrios con monumentos históricos y puede resultar interesante para los análisis posteriores porque puede ser un factor que permita diferenciar entre barrios más antiguos y barrios más modernos.














