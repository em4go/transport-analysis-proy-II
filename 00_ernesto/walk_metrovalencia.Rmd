---
title: "Análisis de bus emt Valencia"
author: "Ernesto Martínez"
output: 
  html_document:
    toc: true
    number_sections: false
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r include=FALSE}
.lib<- c("dplyr", "leaflet", "ggplot2", "tidytransit", "sf", "lubridate", "igraph", "osmdata")


.inst <- .lib %in% installed.packages()
if (length(.lib[!.inst])>0) install.packages(.lib[!.inst])
lapply(.lib, require, character.only=TRUE)

```

```{r}
source("../01_main/utils.R")
```


```{r}
coords_bb <- getbb("Plaza de toros de Valencia")
rownames(coords_bb)
coords_bb["x", ]

# center of the bounding box
coords <- list(x=mean(coords_bb["x", ]), y=mean(coords_bb["y", ]))
coords
```


```{r}
# Cargar los datos
grafo <- read_graph("../data/networks_data/valencia_walk.graphml", format = "graphml")
```


```{r}
is_directed(grafo)
```


```{r}
V(grafo)$x <- as.numeric(V(grafo)$x)
V(grafo)$y <- as.numeric(V(grafo)$y)

E(grafo)$length <- as.numeric(E(grafo)$length)
```


```{r}
start_node <- find_nearest_node(grafo, coords["x"][[1]], coords["y"][[1]])
start_node$x
start_node$y
```


```{r}
# Calcular los nodos más cercanos a start_node

distancias <- distances(grafo, start_node, V(grafo), weights = E(grafo)$length)

class(distancias)
```


```{r}
which(distancias <= 300)
```


```{r}
nodos_cercanos <- V(grafo)[which(distancias <= 300)]
```


```{r}
caminos_cercanos <- shortest_paths(grafo, start_node, nodos_cercanos, weights = E(grafo)$length)
```


```{r}
# Inicializa un vector para almacenar las aristas únicas
aristas_unicas <- c()

# Itera sobre cada camino en vpath
for (camino in caminos_cercanos$vpath) {
  # Verifica si el camino tiene más de un vértice
  if(length(camino) > 1) {
    # Procesa solo los caminos con más de un vértice
    for (i in 1:(length(camino) - 1)) {
      # Encuentra la arista que conecta el par de vértices actual
      arista_actual <- get.edge.ids(grafo, c(camino[i], camino[i+1]), directed = FALSE)
      # Agrega la arista a la lista de aristas únicas si no está ya incluida
      aristas_unicas <- union(aristas_unicas, arista_actual)
    }
  }
}

# Crea un subgrafo con las aristas seleccionadas
subgrafo <- subgraph.edges(grafo, eids = aristas_unicas, delete.vertices = TRUE)
```


```{r}
edge_list <- as_edgelist(subgrafo)
edge_list[1:5,]
```

Dibujar el mapa con leaflet


```{r}
m = leaflet() %>% addTiles()

edges_data <- data.frame(longitude=c(), latitude=c())

for (i in 1:nrow(edge_list)) {
  edge <- edge_list[i,]
  head_edge <- V(subgrafo)[edge[1]]
  tail_edge <- V(subgrafo)[edge[2]]
  
  
  m <- m %>%
    addPolylines(lng = c(head_edge$x, tail_edge$x), lat = c(head_edge$y, tail_edge$y))
  
}

# add nodes to map

m <- m %>% addCircleMarkers(lng = V(subgrafo)$x, lat = V(subgrafo)$y, radius = 5, color = "red")

# add start node to map
m <- m %>% addCircleMarkers(lng = start_node$x, lat = start_node$y, radius = 5, color = "yellow")
m


```

```{r}
plot_isochron <- function(subgrafo) {
  
  edge_list <- as_edgelist(subgrafo)
  
  m = leaflet() %>% addTiles()
  
  for (i in 1:nrow(edge_list)) {
    edge <- edge_list[i,]
    head_edge <- V(subgrafo)[edge[1]]
    tail_edge <- V(subgrafo)[edge[2]]
    
    m <- m %>%
      addPolylines(lng = c(head_edge$x, tail_edge$x), lat = c(head_edge$y, tail_edge$y))
  }
  
  # add nodes to map
  m <- m %>% addCircleMarkers(lng = V(subgrafo)$x, lat = V(subgrafo)$y, radius = 5, color = "red")
  m <- m %>% addCircleMarkers(lng = start_node$x, lat = start_node$y, radius = 5, color = "yellow")
  return(m)
}
```



```{r}
# create function to get the subgraph containing the places where the user can
# go based on a certain metric (for example, the distance), which will be used as
# the weight for the shortest_paths algortihm
isochron <- function(graph, start_node_x, start_node_y, metric, threshold) {
  # Conseguir el nodo más cercano a las coordenadas de inicio
  start_node <- find_nearest_node(graph, start_node_x, start_node_y)
  
  # Calcular los nodos más cercanos a start_node
  distancias <- distances(graph, start_node, V(graph), weights = metric)
  nodos_cercanos <- V(graph)[which(distancias <= threshold)]
  caminos_cercanos <- shortest_paths(graph, start_node, nodos_cercanos, weights = metric)
  
  # Inicializa un vector para almacenar las aristas únicas
  aristas_unicas <- c()
  
  # Itera sobre cada camino en vpath
  for (camino in caminos_cercanos$vpath) {
    # Verifica si el camino tiene más de un vértice
    if(length(camino) > 1) {
      # Procesa solo los caminos con más de un vértice
      for (i in 1:(length(camino) - 1)) {
        # Encuentra la arista que conecta el par de vértices actual
        arista_actual <- get.edge.ids(graph, c(camino[i], camino[i+1]), directed = FALSE)
        # Agrega la arista a la lista de aristas únicas si no está ya incluida
        aristas_unicas <- union(aristas_unicas, arista_actual)
      }
    }
  }
  
  # Crea un subgrafo con las aristas seleccionadas
  subgrafo <- subgraph.edges(graph, eids = aristas_unicas, delete.vertices = TRUE)
  
  return(subgrafo)
}
```


Ver a qué estaciones de metro puedo llegar dentro de ese mapa


```{r}
gtfs <- read_gtfs("../data/gtfs_data/transit_metrovalencia.zip")
```

```{r}
head(gtfs$stops)
```

```{r}
# latitud es la X y longitud es la Y
```


```{r}
xativa_stop <- gtfs$stops[gtfs$stops$stop_name == "Xàtiva",]
xativa_stop

```


```{r}
get_start_node <- function(grafo, location_address) {
  coords_bb <- getbb(location_address)
  coords <- list(x=mean(coords_bb["x", ]), y=mean(coords_bb["y", ]))
  start_node <- find_nearest_node(grafo, coords["x"][[1]], coords["y"][[1]])
  return(start_node)
}
```

```{r}
nodo_entrada <- get_start_node(grafo, "Plaza de toros de Valencia")
```

Ahora vamos a ver qué estaciones de metro son alcanzables en el subgrafo

1. Conseguir punto más cercano a cada estación de metro
2. Calcular distancias del punto más cercano al centro del mapa
3. Colorear el punto donde está la estación de metro
4. Colorear la ruta más cercana del centro del mapa a la estación

```{r}
puntos_mas_cercanos <- data.frame(station_id = character(), station_name = character(), point_id = character(), x = numeric(), y = numeric(), distance_to_start = numeric())
puntos_mas_cercanos
```


```{r}
for (i in 1:nrow(gtfs$stops)) {
  stop <- gtfs$stops[i,]
  punto_mas_cercano <- find_nearest_node(grafo, stop$stop_lon, stop$stop_lat)
  distancia <- distances(grafo, nodo_entrada, punto_mas_cercano, weights = E(grafo)$length)
  puntos_mas_cercanos <- rbind(puntos_mas_cercanos, data.frame(station_id = stop$stop_id, station_name = stop$stop_name, point_id = punto_mas_cercano$id, x = punto_mas_cercano$x, y = punto_mas_cercano$y, distance_to_start = distancia))
}
```

```{r}
nrow(puntos_mas_cercanos)
```

Calcular la distancia de cada estación a un punto en el mapa


```{r}
puntos_mas_cercanos[puntos_mas_cercanos$distance_to_start < 500,]
```

Dibujar las estaciones en un mapa


































